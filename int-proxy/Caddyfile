{
    log {
        output net int-tele-bot:5000 {
            soft_start
        }
    }

    acme_dns infomaniak {env.INFOMANIAK_API_TOKEN}
}

(handle-error) {
    root /errors

    handle_errors {
        @custom_err file /{err.status_code}.html /default.html
        handle @custom_err {
            rewrite * {file_match.relative}
            file_server
        }
        respond "{err.status_code} {err.status_text}"
    }
}

(handle-response) {
    @error status 3xx 4xx 5xx
    handle_response @error {
        copy_response_headers

        @custom_err file /{rp.status_code}.html /default.html
        handle @custom_err {
            rewrite * {file_match.relative}
            file_server {
                status {rp.status_code}
            }
        }

        copy_response
    }
}

(sec-headers) {
    header {
        # disable FLoC tracking
        Permissions-Policy interest-cohort=()

        # enable HSTS
        Strict-Transport-Security max-age=31536000;

        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff

        # clickjacking protection
        X-Frame-Options DENY
    }
}

pihole.{$MY_DOMAIN} {
    import handle-error
    import sec-headers

    log
    encode

    reverse_proxy pihole {
        header_down -X-Content-Type-Options
        header_down -X-Frame-Options

        import handle-response
    }
}

home.{$MY_DOMAIN} {
    import handle-error
    import sec-headers

    log
    encode

    reverse_proxy int-homepage:3000 {
        import handle-response
    }
}
