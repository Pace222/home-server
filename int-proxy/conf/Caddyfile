{
    log {
        output net int-tele-bot:5000 {
            soft_start
        }
    }

    metrics {
        per_host
    }

    admin 172.21.3.3:2019 {
        origins 172.21.3.3:2019 int-proxy:2019
    }

    acme_dns infomaniak {$INFOMANIAK_API_TOKEN}
}

import /etc/caddy-configs/*

pacemox.{$MY_DOMAIN} {
    log

    reverse_proxy {$PROXMOX_IP}:8006 {
        transport http {
            tls_insecure_skip_verify
        }
    }
}

opnsense.{$MY_DOMAIN} {
    log

    reverse_proxy {$OPNSENSE_IP}
}

home.{$MY_DOMAIN} {
    import security
    import error-handling

    log
    encode

    import csp {
        vars {
            csp-style-src "'self' 'unsafe-inline'"
            csp-img-src "'self' https://cdn.jsdelivr.net/"
        }
    }

    reverse_proxy /api* int-homepage:3000

    reverse_proxy int-homepage:3000 {
        import forward-proxy-error
    }
}

pihole.{$MY_DOMAIN} {
    import security
    import error-handling

    log
    encode

    route {
        import authenticate {
            vars ignore me
        }

        import csp {
            vars ignore me
        }

        redir /favicon.ico /admin/img/favicons/favicon.ico

        redir / /admin/

        reverse_proxy /api* pihole

        reverse_proxy pihole {
            import forward-proxy-error
        }
    }
}

grafana.{$MY_DOMAIN} {
    import security
    import error-handling

    log
    encode

    route {
        import authenticate {
            vars auth-username true
            vars auth-email true
            vars auth-name true
        }

        import csp {
            vars {
                csp-script-src "'self' 'unsafe-inline' 'unsafe-eval'"
                csp-style-src "'self' 'unsafe-inline'"
            }
        }

        redir /favicon.ico /public/img/fav32.png

        reverse_proxy /api* grafana:3000

        reverse_proxy grafana:3000 {
            import forward-proxy-error
        }
    }
}
