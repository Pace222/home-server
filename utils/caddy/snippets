(security) {
    header {
        # disable FLoC tracking
        >Permissions-Policy interest-cohort=()

        # enable HSTS
        >Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

        # disable clients from sniffing the media type
        >X-Content-Type-Options nosniff

        # clickjacking protection
        >X-Frame-Options DENY

        # referrer privacy
        >Referrer-Policy no-referrer
    }

    route /.well-known/security.txt {
        respond <<EOF
            Contact: mailto:security@{$MY_DOMAIN}
            Expires: 2030-01-01T00:00:00.000Z
            Preferred-Languages: en, fr, de, it

            EOF 200
    }
}

(security-and-error-handling) {
    # Need to define it here...
    import security

    handle_errors {
        # ... and here because they are two different contexts
        import security

        @custom_err file /error-pages/{err.status_code}.html /error-pages/default.html
        handle @custom_err {
            rewrite * {file_match.relative}
            file_server
        }

        respond {err.status_text} {err.status_code}
    }
}

(handle-proxy-error) {
    @error status 3xx 4xx 5xx
    handle_response @error {
        copy_response_headers {
            include Location WWW-Authenticate
        }

        error {rp.status_text} {rp.status_code}
    }
}

(no-crawl-no-index) {
    header {
        >X-Robots-Tag "noindex, nofollow"
    }

    route /robots.txt {
        respond <<EOF
            User-agent: *
            Disallow: /

            EOF 200
    }
}

(authenticate) {
    route {
        reverse_proxy /outpost.goauthentik.io/* authentik-server:9000

        forward_auth authentik-server:9000 {
            uri /outpost.goauthentik.io/auth/caddy

            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Entitlements X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version
        }
    }
}
