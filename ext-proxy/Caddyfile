{
    log {
        output net ext-tele-bot:5000 {
            soft_start
        }
    }

    metrics {
        per_host
    }

    admin 172.21.2.3:2019 {
        origins ext-proxy:2019
    }
}

(sec-headers) {
    header {
        # disable FLoC tracking
        >Permissions-Policy interest-cohort=()

        # enable HSTS
        >Strict-Transport-Security max-age=31536000;

        # disable clients from sniffing the media type
        >X-Content-Type-Options nosniff

        # clickjacking protection
        >X-Frame-Options DENY

        # additional headers
        {block}
    }
}

(headers-and-error-handling) {
    # Need to define it here...
    import sec-headers {
        {block}
    }

    root /error-pages

    handle_errors {
        # ... and here because they are two different contexts
        import sec-headers {
            {block}
        }

        @custom_err file /{err.status_code}.html /default.html
        handle @custom_err {
            rewrite * {file_match.relative}
            file_server
        }

        respond {err.status_text} {err.status_code}
    }
}

(handle-proxy-error) {
    @error status 3xx 4xx 5xx
    handle_response @error {
        copy_response_headers {
            include Location WWW-Authenticate
        }

        error {rp.status_text} {rp.status_code}
    }
}

{$MY_DOMAIN} {
    import headers-and-error-handling

    log
    encode

    reverse_proxy /api* ext-homepage:3000

    reverse_proxy ext-homepage:3000 {
        import handle-proxy-error
    }
}

dabloon.{$MY_DOMAIN} {
    import headers-and-error-handling {
        >X-Robots-Tag "noindex, nofollow"
    }

    log
    encode

    redir /favicon.ico /img/favicon.ico

    reverse_proxy dabloon {
        header_down -Server

        import handle-proxy-error
    }
}

vpn.{$MY_DOMAIN} {
    import headers-and-error-handling {
        >X-Robots-Tag "noindex, nofollow"
    }

    redir https://{$MY_DOMAIN} permanent
}
