{
    log {
        output net ext-tele-bot:5000 {
            soft_start
        }
    }

    metrics {
        per_host
    }

    admin 172.21.2.3:2019 {
        origins ext-proxy:2019
    }
}

import caddy-configs/*

{$MY_DOMAIN} {
    import security-and-error-handling

    log
    encode

    reverse_proxy /api* ext-homepage:3000

    reverse_proxy ext-homepage:3000 {
        import handle-proxy-error
    }
}

www.{$MY_DOMAIN} {
    import security-and-error-handling
    import no-crawl-no-index

    redir https://{$MY_DOMAIN}{uri} permanent
}

auth.{$MY_DOMAIN} {
    import security-and-error-handling
    import no-crawl-no-index

    log
    encode

    reverse_proxy authentik-server:9000
}

dabloon.{$MY_DOMAIN} {
    import security-and-error-handling
    import no-crawl-no-index

    log
    encode

    route {
        import authenticate

        reverse_proxy dabloon {
            header_down -Server

            import handle-proxy-error
        }
    }
}

vpn.{$MY_DOMAIN} {
    import security-and-error-handling
    import no-crawl-no-index

    redir https://{$MY_DOMAIN} permanent
}

mta-sts.{$MY_DOMAIN} {
    route {
        respond /.well-known/mta-sts.txt <<EOF
            version: STSv1
            mode: enforce
            mx: mailserver.purelymail.com
            max_age: 86400
            EOF 200

        error 404
    }
}
